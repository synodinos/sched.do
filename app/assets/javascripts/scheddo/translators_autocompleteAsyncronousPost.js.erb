Namespaced.declare('Scheddo.Translators');

Scheddo.Translators.AutocompleteAsyncronousPost = _.extend((function(){
  var setRemoveClickEvent = function(markup, invitee){
    markup.children('.remove').click(function(){
      Scheddo.Util.removeInviteeFromQueue(invitee);
      markup.remove();
    });
  };

  return {
    addMethodsToUser: function(user){
      user.submit = function(event, form){
        Scheddo.Util.inviteeQueue.push(user);
        var markup = $(Scheddo.Templates.getUserInviteeTemplate(user));
        setRemoveClickEvent(markup, user);

        $('.users.list-invitees').append(markup);
        $('#invite_users').hide();
      };

      user.post = function(eventId){
        Scheddo.
          Translators.
          Requests.
          userAsync(user, eventId);
      };

      return user;
    },

    translateUsers: function(userData){
      var self = this;
      return _(userData).map(function(userObject) {
        var user = Scheddo.Translators.translateUser(userObject);
        return self.addMethodsToUser(user);
      }).reverse();
    },

    addMethodsToGroup: function(group){
      group.submit = function(event, form){
        Scheddo.Util.inviteeQueue.push(group);
        markup = $(Scheddo.Templates.getGroupInviteeTemplate(group));
        setRemoveClickEvent(markup, group);

        $('#invite_groups').hide();
        $('.invited-groups.list-invitees').append(markup);
      };

      group.post = function(eventId){
        Scheddo.
          Translators.
          Requests.
          groupAsync(group, eventId);
      };

      return group;
    },

    translateGroups: function(groupData){
      var self = this;
      return _(groupData).map(function(groupObject) {
        var group = Scheddo.Translators.translateGroup(groupObject);
        return self.addMethodsToGroup(group);
      }).reverse();
    },

    addMethodsToEmail: function(email){
      email.submit = function(event, form){
        var emailRegEx = /^([^@\s]+)@(([-a-z0-9]+\.)+[a-z]{2,})$/i
        if (email.value.search(emailRegEx) == -1) {
          Scheddo.Util.setFlash('flash-error', 'Invitee email is not an email, Invitee is invalid');
        }
        else{
          Scheddo.Util.inviteeQueue.push(email);
          markup = $(Scheddo.Templates.getEmailInviteeTemplate(email));
          setRemoveClickEvent(markup, email);

          $('#invite_users').hide();
          $('.users.list-invitees').append(markup);
        }
      };

      email.post = function(eventId){
        Scheddo.
          Translators.
          Requests.
          emailAsync(email, eventId);
      };

      return email;
    },

    translateEmail: function(term){
      var self = this;
      var email = Scheddo.Translators.translateEmail(term);
      return self.addMethodsToEmail(email);
    }
  };
})(), Scheddo.Translators.FullResults);
