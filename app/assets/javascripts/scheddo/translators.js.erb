Namespaced.declare('Scheddo');

Scheddo.Translators = {
  translateUser: function(userData){
    var user = Scheddo.Models.user(userData);
    user.label = user.fullName;
    user.value = user.fullName;
    user.type = 'user';
    user.render = function(){
      return $(Scheddo.Templates.getUserMenuItemTemplate(this)).
        data('ui-autocomplete-item', this);
    };

    return user;
  },

  translateGroup: function(groupData){
    var group = Scheddo.Models.group(groupData);
    group.label = group.fullName;
    group.value = group.fullName;
    group.type = 'group'
    group.render = function(){
      return $(Scheddo.Templates.getGroupMenuItemTemplate(this)).
        data('ui-autocomplete-item', this);
    };

    return group;
  },

  translateEmail: function(term){
    return {
      label: escape(term),
      value: escape(term),
      type: 'email',
      render: function(){
        return $(Scheddo.Templates.getEmailItemTemplate(this)).
          data('ui-autocomplete-item', this);
      }
    }
  },
};

Scheddo.Translators.FullResults = {
  normalizeTranslatedResponse: function(term, response){
    var self = this;
    return function(yammerData){
      var users = self.translateUsers(yammerData.user);
      var groups = self.translateGroups(yammerData.group);
      var email = self.translateEmail(term);
      var items = users.concat(groups);
      items.push(email);

      response(items);
    }
  }
};

Scheddo.Translators.RenderInInviteeList = {
  setRemoveClickEvent: function(markup, invitee){
    markup.children('.remove').click(function(){
      Scheddo.Util.removeInviteeFromQueue(invitee);
      markup.remove();
    });
  },

  renderGroup: function(group){
    markup = $(Scheddo.Templates.getGroupInviteeTemplate(group));
    this.setRemoveClickEvent(markup, group);

    $('#invite_groups').hide();
    $('.invited-groups.list-invitees').append(markup);
  },

  renderUser: function(user){
    var markup = $(Scheddo.Templates.getUserInviteeTemplate(user));
    this.setRemoveClickEvent(markup, user);

    $('.users.list-invitees').append(markup);
    $('#invite_users').hide();
  },

  renderEmail: function(email){
    markup = $(Scheddo.Templates.getEmailInviteeTemplate(email));
    this.setRemoveClickEvent(markup, email);

    $('#invite_users').hide();
    $('.users.list-invitees').append(markup);
  }
};

Scheddo.Translators.Requests = {
  completedPost: function(objectToRemove){
    if(Scheddo.Util.inviteeQueue.length === 1){
      $('#new_event').unbind('submit');
      $('#new_event').submit();
    }
    else{
      Scheddo.Util.removeInviteeFromQueue(objectToRemove);
    }
  },

  userAsync: function(user, eventId){
    var self = this;
    $.ajax({
      type: 'POST',
      url: '<%= Rails.application.routes.url_helpers.yammer_user_invitations_path %>',
      data: {
        invitation: {
          event_id: eventId,
          invitee_attributes: {
            yammer_user_id: user.id
          }
        }
      },
      complete: function(data, status, xhr){
        self.completedPost(user);
      },
    });
  },

  groupAsync: function(group, eventId){
    var self = this;
    $.ajax({
      type: 'POST',
      url: '<%= Rails.application.routes.url_helpers.yammer_group_invitations_path %>',
      data: {
        invitation: {
          event_id: eventId,
          invitee_attributes: {
            name_or_email: group.fullName,
            yammer_group_id: group.id
          }
        }
      },
      complete: function(data, status, xhr){
        self.completedPost(group);
      }
    });
  },

  emailAsync: function(email, eventId){
    var self = this;
    $.ajax({
      type: 'POST',
      url: '<%= Rails.application.routes.url_helpers.invitations_path %>',
      data: {
        invitation: {
          event_id: eventId,
          invitee_attributes: {
            name_or_email: email.value,
          }
        }
      },
      complete: function(data, status, xhr){
        self.completedPost(email);
      }
    });
  }
};
